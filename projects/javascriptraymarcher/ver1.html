<html>
<head>
<title>Canvas tutorial</title>
<style type="text/css">
canvas { border: 1px solid black; }
</style>
<script src="jquery-1.3.2.js" type="text/javascript" charset="utf-8"></script>
<script src="Dumper.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">


var ctx;
var canvas;
var outWin;
function setup(){
	//Graph is a handy wrapper object for dealing with the output window.
	outWin = new Graph('canvasdiv');
	outWin.erase(ctx);
	//Kick off the render
	renderImage();
}

var x = 0;
var y = 0;
function renderImage () {
	//If we try to draw the entire picture in one go, the browser will freeze.  So instead we draw one pixel at a time.
	x++;
	if (x>=outWin.width) {
		x=0;
		y++;
		if (y>=outWin.height) {
			//finished
			return;
			alert("Finished");
		}
	}
	ray = new Ray( x, y );
	
	//The ray object contains the position and direction of the ray.  castRay walks along the ray, looking for terrain.
	if( castRay( ray.origin, ray.direction ) )
		{ outWin.setPixel(x,y,terrainColour( ray, t )); }  //We hit the terrain, draw the ground colour
	else
		{ outWin.setPixel( x, y,  skyColour()); }  //We missed the terrain, draw the sky colour

	//Give the browser some time to do other processing
	setTimeout("renderImage()", 10);
}

//This is the function that sets the shape of the ground.  Simple for now, it will get very complicated soon.
function f(x,z) { return 2;}
//function f(x,z) { return Math.sin(x) + Math.sin(z);}

function castRay(   ro,  rd ) {
     delt = 0.01;
     mint = 0.001;
     maxt = 10.0;
    //Step along the ray 
    for( t = mint; t < maxt; t += delt )
    {
	p =  jQuery.extend(true, {}, ro);
	dir = jQuery.extend(true, {}, rd);
	dir.mult(t);
        p.add(dir);

        if( p.y < f( p.x, p.z ) )
	//We've sunk into the ground.  
        {
            //resT = t - 0.5f*delt;
            return true;
        }
    }
    return false;
}

//Clumsy attempt at a vector object
function Vector ( xx, yy, zz) {
this.x = xx;
this.y = yy;
this.z = zz;

this.add = function (aVec) {
this.x =this.x + aVec.x;
this.y =this.y + aVec.y;
this.z =this.z + aVec.z;
}

this.mult = function (aScalar) {
this.x = this.x * aScalar;
this.y = this.y * aScalar;
this.z = this.z * aScalar;
}

}

//This creates a ray, pointing in the right direction
function Ray (x,y) {
this.origin = new Vector (x,y-outWin.height/2,0);
this.direction = new Vector (0,0,1);
}


function terrainColour() { return "#AAAA00"}
function skyColour () { return "#0000FF"}

function Graph(aCanvas, aLength) {
	this.canvas = document.getElementById('canvasdiv');
	this.width = this.canvas.width;
	this.height = this.canvas.height;
	if (this.canvas.getContext){
		this.ctx = this.canvas.getContext('2d');
	}
	function redraw (somedata, aLength) {
		gr = this.ctx;
		this.erase();
		myLength = somedata.length || aLength;
		for ( ii=0;ii<myLength;ii++) {
			if ((currind == ii) && (mode == 'anneal')) {
				gr.fillStyle = "#00FF00";
			} else {
				gr.fillStyle = "#FF0000";
			}
			gr.fillRect( ii, 0, 1, somedata[ii][2] );
		};
	}
	this.redraw=redraw;

	this.setPixel = function (x, yy, aColor) {
		var y = this.height - yy;
		aCtx = outWin.ctx;
		outWin.ctx.strokeStyle = aColor;
		aCtx.beginPath();
		aCtx.moveTo(x-1,y-1);
		aCtx.lineTo(x,y);
		aCtx.stroke();

	};


	function erase () {
		aCtx = this.ctx;
		aCtx.fillStyle = "#000000";
		aCtx.globalAlpha=1;
		aCtx.strokeStyle ='#FFFFFF';
		aCtx.fillRect( 0, 0, this.canvas.width, this.canvas.height);
	}
	this.erase = erase;
}



//Pack 3 numbers into the '#ABCDEF' format needed for html
function rgb(red, green, blue)
{
	var decColor = red + 256 * green + 65536 * blue;
	return '#'+decColor.toString(16);
}


</script>
</head>
<body onload="setup();">
<canvas id="canvasdiv" width="100" height="100"></canvas>
<div id="debugdiv"></div>
<div>
This is the start of the raytracer.  It creates rays and walks them into the landscape.  When it hits the terrain, it is coloured brown, otherwise it gets the skysphere colour.  Because there isn't any code for the lens of the camera, I sank the camera halfway into the ground so the ground would appear in the picture.
</div>
</body>
</html>
