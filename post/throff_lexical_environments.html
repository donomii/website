
			<!DOCTYPE html>
			<html lang="en">
			<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1">
			<meta name="color-scheme" content="light dark">
			<link rel="icon" type="image/png" href="data:image/png;base64,">
			<title>blog/ Lexical Environments in Throff</title>
			<style>
				@media (prefers-color-scheme: dark){
					body {
						background:#000;
						--bg-color: #000;
					}
				}
				body{
					margin:1em auto;
					max-width:40em;
					padding:0 .62em 3.24em;
					font:1.2em/1.62 sans-serif;
					--bg-color: white;
				}
				h1,h2,h3 {
					line-height:1.2
				}
				article h1 {
					margin-left: 0;
					text-align: center;
				}
				.summary {
					text-align: center;
				}
				@media print{
					body{
						max-width:none
					}
				}
				img {
					max-width: 25%;
					height: auto;
					float: left;
					margin: 0 1em 1em 0;
				}
				img.right {
					float: right;
					margin: 0 0 1em 1em;
				}
				article img {
					cursor: pointer;
					transition: opacity 0.2s;
				}
				article img:hover {
					opacity: 0.85;
				}
				.lightbox-overlay {
					display: none;
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 100%;
					background: rgba(0, 0, 0, 0.9);
					z-index: 9999;
					justify-content: center;
					align-items: center;
					cursor: pointer;
				}
				.lightbox-overlay.active {
					display: flex;
				}
				.lightbox-overlay img {
					max-width: 90%;
					max-height: 90%;
					object-fit: contain;
					border-radius: 4px;
					box-shadow: 0 0 30px rgba(0,0,0,0.5);
					float: none;
					margin: 0;
					cursor: default;
				}
				.lightbox-close {
					position: absolute;
					top: 20px;
					right: 30px;
					color: white;
					font-size: 40px;
					font-weight: bold;
					cursor: pointer;
				}
				.lightbox-close:hover {
					color: #ccc;
				}
			</style>
			<article>
			<header>

			<h1>blog/ Lexical Environments in Throff</h1>
			</header>
			<div class="summary">
<p>I finally have lexical environments sorted out in <a href="../../projects/throff/">Throff</a>.</p>
</div>
<div style="clear:both"></div>
<div style="text-align: center; margin: 2em 0;"><span style="display: inline-block; width: 20%; border-top: 2px solid #333; position: relative;"><span style="position: absolute; top: -0.6em; left: 50%; transform: translateX(-50%); background: var(--bg-color, white); padding: 0 0.5em; font-size: 1.5em;">â—†</span></span></div>
<p>Never again.</p>
<p>Lexical scoping has been by far the hardest part of implementing <a href="../../projects/throff/">Throff</a>.  Each time I think I have it working, I hit an edge case and realise I need to change the design again.  But this time around, I think I have finally got a working design.</p>
<p>Previously, every data item in Throff held a pointer to its lexical environment.  This was needed, because the current lexical scope was always taken from the current instruction (or previous, in the case of macros).  This was needed to choose the correct environment when Throff created a new data item.  e.g.</p>
<pre><code>ADD 1 1

2
</code></pre>
<p>when Throff created the result &quot;2&quot;, it used the environment from the previous &quot;1&quot;.  Having an environment isn't so useful for numbers, but it was important when evaluating strings.  e.g.</p>
<pre><code>EVAL STRING-CONCATENATE &quot;PRINTLN&quot; &quot;GREETING&quot;
SETLEX GREETING =&gt; -&gt;STRING [ PRINTLN HELLO_WORLD ]
</code></pre>
<p>EVAL <em>does</em> need a lexical environment to lookup the variable GREETING so it can print out HELLO_WORLD.  Previously, it would use the environment of the string.  But this won't work if the string was created in a different namespace.  The lookup for &quot;GREETING&quot; will happen in a different namespace to the current one.  There are similar problems dealing with continuations and error handling</p>
<p>Now, EVAL it requires an environment as an argument, which has the benefit of allowing you to evaluate code in a different environment to the one that the code appears in.</p>
<pre><code>EVAL text IN ENVIRONMENTOF token
</code></pre>
<p>Since TOKEN and CODE (and LAMBDA) are now the only datatypes allowed to have an environment, you will have to explicitly get the environment with</p>
<pre><code>ENVIRONMENTOF abcd TOK
</code></pre>
<p>TOK &quot;quotes&quot; abcd, pushing it onto the data stack instead of treating it like a variable to be looked up and replaced with a value.    ENVIRONMENTOF extracts the lexical environment from the TOKEN &quot;abcd&quot;.  Under the hood, an environment is just a HASH, and so you can use ordinary hash functions on it.  So for instance, you can dump the current lexical environment with</p>
<pre><code>ITERATE [ PRINTLN ] KEYS ENVIRONMENTOF abcd TOK
</code></pre>
<p>This is also a handy way to deal with namespaces, although the semantics of updating an immutable namespace get a bit weird.</p>

			</article>
			<div class="lightbox-overlay" id="lightbox">
				<span class="lightbox-close" id="lightbox-close">&times;</span>
				<img src="" alt="" id="lightbox-img">
			</div>
			<script>
			(function() {
				var overlay = document.getElementById('lightbox');
				var lightboxImg = document.getElementById('lightbox-img');
				var closeBtn = document.getElementById('lightbox-close');
				
				// Add click handler to all images in the article
				document.querySelectorAll('article img').forEach(function(img) {
					img.addEventListener('click', function(e) {
						e.preventDefault();
						lightboxImg.src = this.src;
						lightboxImg.alt = this.alt;
						overlay.classList.add('active');
					});
				});
				
				// Close on overlay click
				overlay.addEventListener('click', function(e) {
					if (e.target === overlay || e.target === closeBtn) {
						overlay.classList.remove('active');
					}
				});
				
				// Close on escape key
				document.addEventListener('keydown', function(e) {
					if (e.key === 'Escape') {
						overlay.classList.remove('active');
					}
				});
			})();
			</script>
			</html>
			